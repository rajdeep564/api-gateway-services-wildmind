import { Request, Response, NextFunction } from 'express';
import { body, validationResult } from 'express-validator';
import { ApiError } from '../../../utils/errorHandler';

// Voice IDs for Kling Lipsync
const allowedVoiceIds = [
  'en_AOT',
  'en_oversea_male1',
  'en_girlfriend_4_speech02',
  'en_chat_0407_5-1',
  'en_uk_boy1',
  'en_PeppaPig_platform',
  'en_ai_huangzhong_712',
  'en_calm_story1',
  'en_uk_man2',
  'en_reader_en_m-v1',
  'en_commercial_lady_en_f-v1',
  'zh_genshin_vindi2',
  'zh_zhinen_xuesheng',
  'zh_tiyuxi_xuedi',
  'zh_ai_shatang',
  'zh_genshin_klee2',
  'zh_genshin_kirara',
  'zh_ai_kaiya',
  'zh_tiexin_nanyou',
  'zh_ai_chenjiahao_712',
  'zh_girlfriend_1_speech02',
  'zh_chat1_female_new-3',
  'zh_girlfriend_2_speech02',
  'zh_cartoon-boy-07',
  'zh_cartoon-girl-01',
  'zh_ai_huangyaoshi_712',
  'zh_you_pingjing',
  'zh_ai_laoguowang_712',
  'zh_chengshu_jiejie',
  'zh_zhuxi_speech02',
  'zh_uk_oldman3',
  'zh_laopopo_speech02',
  'zh_heainainai_speech02',
  'zh_dongbeilaotie_speech02',
  'zh_chongqingxiaohuo_speech02',
  'zh_chuanmeizi_speech02',
  'zh_chaoshandashu_speech02',
  'zh_ai_taiwan_man2_speech02',
  'zh_xianzhanggui_speech02',
  'zh_tianjinjiejie_speech02',
  'zh_diyinnansang_DB_CN_M_04-v2',
  'zh_yizhipiannan-v1',
  'zh_guanxiaofang-v2',
  'zh_tianmeixuemei-v1',
  'zh_daopianyansang-v1',
  'zh_mengwa-v1',
];

export const validateKlingLipsync = [
  body('model').optional().isString(),
  body('video_url').optional().isString().isLength({ min: 1 }),
  body('video_id').optional().isString().isLength({ min: 1 }),
  body('text').optional().isString().isLength({ min: 1, max: 2000 }),
  body('audio_file').optional().isString().isLength({ min: 1 }),
  body('voice_id').optional().isIn(allowedVoiceIds),
  body('voice_speed').optional().isFloat({ min: 0.8, max: 2 }),
  (req: Request, _res: Response, next: NextFunction) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) return next(new ApiError('Validation failed', 400, errors.array()));

    // At least one of video_url or video_id is required
    if (!req.body.video_url && !req.body.video_id) {
      return next(new ApiError('video_url or video_id is required for Kling Lipsync', 400));
    }

    // Cannot use both video_url and video_id
    if (req.body.video_url && req.body.video_id) {
      return next(new ApiError('Cannot use both video_url and video_id', 400));
    }

    // If using text (not audio_file), text is required
    if (!req.body.audio_file && !req.body.text) {
      return next(new ApiError('text or audio_file is required for Kling Lipsync', 400));
    }

    // Default model
    if (!req.body.model) {
      req.body.model = 'kwaivgi/kling-lip-sync';
    }

    // Default voice_id if using text
    if (!req.body.audio_file && !req.body.voice_id) {
      req.body.voice_id = 'en_AOT';
    }

    // Default voice_speed if using text
    if (!req.body.audio_file && req.body.voice_speed === undefined) {
      req.body.voice_speed = 1;
    }

    return next();
  },
];


